<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DSL-/FRITZ!Box Ereignisse – Übersicht</title>
<meta name="description" content="Öffentliche Übersicht der DSL-/Internet-Ereignisse inkl. Speedtests." />
<style>
  :root{
    --bg:#0b0d10;--panel:#12161b;--text:#e6edf3;--muted:#9aa5b1;--border:#1f2833;
    --ok:#2ecc71;--sync:#2bb1ff;--error:#e5534b;--speedtest:#7c6ff6;--info:#58c4b8;--wiring:#ff9f40
  }
  @media (prefers-color-scheme: light){
    :root{--bg:#f6f7f9;--panel:#ffffff;--text:#1f2328;--muted:#576170;--border:#e6e8eb}
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif}
  .wrap{max-width:920px;margin:auto;padding:28px 16px}
  h1{margin:0 0 6px;font-size:clamp(22px,3.6vw,32px)}
  .muted{color:var(--muted)}
  /* Legend */
  .legend{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0 0}
  .legend .item{display:flex;align-items:center;gap:8px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .sync{background:var(--sync)} .error{background:var(--error)}
  .speedtest{background:var(--speedtest)} .info{background:var(--info)} .wiring_issue{background:var(--wiring)}
  .legend-wrap{padding-bottom:0;margin-bottom:0}
  .rule{width:100%;height:1px;background:var(--border);margin:10px 0 12px;border-radius:1px}
  /* Controls */
  .tools{display:flex;gap:8px;align-items:center;margin:12px 0 16px}
  input[type=search]{flex:1;min-width:180px;padding:10px 12px;border:1px solid var(--border);
    border-radius:12px;background:transparent;color:var(--text)}
  button{appearance:none;background:transparent;color:var(--text);border:1px solid var(--border);
    padding:8px 12px;border-radius:12px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  /* KPIs */
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px}
  .kpi{border:1px solid var(--border);padding:8px 10px;border-radius:10px}
  /* List */
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px}
  .list{list-style:none;margin:0;padding:0}
  .item{
    display:grid;
    grid-template-columns:140px 1fr;
    gap:12px;
    padding:12px 16px;
    border:2px solid transparent;
    border-radius:14px;
    margin:8px 0;
  }
  .item.type-ok{ border-color: var(--ok); }
  .item.type-sync{ border-color: var(--sync); }
  .item.type-error{ border-color: var(--error); }
  .item.type-speedtest{ border-color: var(--speedtest); }
  .item.type-wiring_issue{ border-color: var(--wiring); }
  .item.type-info{ border-color: var(--info); }
  .ts{font-variant-numeric:tabular-nums;color:var(--muted)}
  .title{font-weight:600}
  .meta{color:var(--muted);font-size:0.95em;margin-top:2px}
  @media (max-width:640px){.item{grid-template-columns:1fr}.ts{order:2}}
  @media print{.tools,.legend-wrap,.kpis,.rule{display:none}}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="title">DSL-/FRITZ!Box Ereignisse</h1>
    <p class="muted" id="subtitle">Lädt …</p>
    <div class="legend-wrap">
      <div class="legend">
        <span class="item"><span class="dot ok"></span>OK</span>
        <span class="item"><span class="dot sync"></span>Sync</span>
        <span class="item"><span class="dot error"></span>Fehler</span>
        <span class="item"><span class="dot speedtest"></span>Speedtest</span>
        <span class="item"><span class="dot wiring_issue"></span>Verkabelung</span>
        <span class="item"><span class="dot info"></span>Info</span>
      </div>
    </div>
    <div class="rule"></div>
    <div class="tools">
      <input id="q" type="search" placeholder="Suche… (z. B. Speedtest-ID, Fehler)">
      <button id="btnProblems">Nur Störungen</button>
      <button id="btnPrint">PDF</button>
    </div>
    <div class="kpis">
      <div class="kpi">OK: <b id="kpiOk">–</b></div>
      <div class="kpi">Sync: <b id="kpiSync">–</b></div>
      <div class="kpi">Fehler: <b id="kpiErr">–</b></div>
      <div class="kpi">Speedtests: <b id="kpiTests">–</b></div>
      <div class="kpi">Down (Min/Ø/Max): <b id="kpiDown">–</b> Mbit/s</div>
    </div>
  </header>

  <section class="panel">
    <ul id="list" class="list" aria-label="Ereignisliste"></ul>
  </section>

  <footer class="muted" style="margin-top:18px;font-size:13px">
    Datenquelle: <code>events.json</code> (gleicher Ordner). Zeiten werden lokal dargestellt.
  </footer>
</div>

<script>
  const state = { data:null, onlyProblems:false };
  const list = document.getElementById('list');
  const kpi = {
    ok:document.getElementById('kpiOk'),
    sync:document.getElementById('kpiSync'),
    err:document.getElementById('kpiErr'),
    tests:document.getElementById('kpiTests'),
    down:document.getElementById('kpiDown'),
  };

  // --- Utils ---
  function parseToDate(dt){
    if(!dt) return null;
    if(/^\d{4}-\d{2}-\d{2}T/.test(dt)){ const t=Date.parse(dt); return Number.isNaN(t)?null:new Date(t); }
    const m=dt.match(/^(\d{2})\.(\d{2})\.(\d{2})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
    if(m){const yyyy=(+m[3]<50?2000+ +m[3]:1900+ +m[3]);return new Date(yyyy,+m[2]-1,+m[1],+m[4],+m[5],+(m[6]||0));}
    const t=Date.parse(dt); return Number.isNaN(t)?null:new Date(t);
  }
  function fmt(dtStr){
    const d=parseToDate(dtStr); if(!d) return {date:'—',time:''};
    return {
      date:d.toLocaleDateString('de-DE'),
      time:d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
    };
  }

  // --- Migration/Normalisierung alter Typen ---
  const TYPE_MAP = { training:'sync', disconnect:'error' };
  function normalizeType(e){
    let t = (e.type||'info').toLowerCase();
    if(TYPE_MAP[t]) t = TYPE_MAP[t];

    // Titel-basierte Korrekturen (falls alte JSON andere Typen gesetzt hat)
    const title = (e.title||'').toLowerCase();
    if(title.startsWith('dsl ist verfügbar')) t = 'ok';
    else if(title.startsWith('internetverbindung wurde erfolgreich hergestellt')) t = 'ok';
    else if(title.startsWith('dsl antwortet nicht')) t = 'error';
    else if(title.startsWith('internetverbindung wurde getrennt')) t = 'error';
    else if(title.startsWith('vodafone speedtest')) t = 'speedtest';
    else if(title.startsWith('unzulässige verkabelung erkannt')) t = 'wiring_issue';

    return t;
  }
  function normalizeEvent(e){
    const t = normalizeType(e);
    return {...e, type:t};
  }

  function render(){
    const raw = state.data?.events || [];
    const ev = raw.map(normalizeEvent); // <-- immer normalisieren

    document.getElementById('title').textContent = state.data?.meta?.title || 'DSL-/FRITZ!Box Ereignisse';
    document.getElementById('subtitle').textContent = `Zeitzone: ${state.data?.meta?.timezone || '—'}`;

    list.innerHTML = ev.map(e=>{
      const {date,time} = fmt(e.dt);
      const cls = e.type || 'info';
      let meta = '';
      if(cls==='speedtest'){
        meta = `ID ${e.id} · ${e.down} ↓ / ${e.up} ↑ Mbit/s`;
      }else if(cls==='wiring_issue'){
        const parts = [];
        if(e.length_m) parts.push(`Abzweig ${e.length_m} m`);
        if(e.loss_kbit) parts.push(`Verlust ${e.loss_kbit} kbit/s`);
        meta = (e.details || e.message || '') + (parts.length? ' · '+parts.join(' · '):'');
      }else if(e.details){ meta = e.details; }

      return `<li class="item type-${cls}" data-type="${cls}">
        <div class="ts">${date}${time?` ${time}`:''}</div>
        <div>
          <div class="title">${e.title || ''}</div>
          ${meta ? `<div class="meta">${meta}</div>` : ``}
        </div>
      </li>`;
    }).join('') || `<li class="item type-info"><div class="ts">–</div><div>Keine Einträge</div></li>`;

    // KPIs mit normalisierten Events
    refreshKPIs(ev);
    applyFilters();
  }

  // Filter
  const q = document.getElementById('q');
  document.getElementById('btnProblems').addEventListener('click', ()=>{
    state.onlyProblems = !state.onlyProblems;
    applyFilters();
  });
  document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
  q.addEventListener('input', applyFilters);

  function applyFilters(){
    const term = q.value.trim().toLowerCase();
    const problemTypes = new Set(['error','wiring_issue']);
    Array.from(list.children).forEach(li=>{
      const t = li.getAttribute('data-type');
      const text = li.textContent.toLowerCase();
      let show = true;
      if(term && !text.includes(term)) show=false;
      if(state.onlyProblems && !problemTypes.has(t)) show=false;
      li.style.display = show ? '' : 'none';
    });
  }

  function refreshKPIs(events){
    const counts = { ok:0, sync:0, error:0, speedtest:0, wiring_issue:0, info:0 };
    const downs=[];
    (events||[]).forEach(e=>{
      counts[e.type] = (counts[e.type]||0)+1;
      if(e.type==='speedtest' && typeof e.down!=='undefined'){
        downs.push(+String(e.down).toString().replace(',','.'));
      }
    });
    kpi.ok.textContent = counts.ok||0;
    kpi.sync.textContent = counts.sync||0;
    kpi.err.textContent = counts.error||0;
    kpi.tests.textContent = counts.speedtest||0;
    if(downs.length){
      const min = Math.min(...downs);
      const max = Math.max(...downs);
      const avg = Math.round(downs.reduce((a,b)=>a+b,0)/downs.length);
      kpi.down.textContent = `${min} / ${avg} / ${max}`;
    } else kpi.down.textContent = '–';
  }

  // Daten laden
  fetch('events.json',{cache:'no-store'})
    .then(r=>r.ok?r.json():{meta:{},events:[]})
    .then(json=>{ state.data=json; render(); })
    .catch(()=>{ state.data={meta:{},events:[]}; render(); });
</script>
</body>
</html>
